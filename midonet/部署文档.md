# Midonet部署及使用Neutron网络初始化

------

本文档涉及以下内容：
> * 安装前的准备
> * keystone安装部署
> * neutron及相关组件安装配置
> * zookeeper安装部署
> * cassandra安装部署
> * midonet-api安装部署
> * tomcat7安装
> * midoman安装
> * 使用neutron进行网络初始化

## 准备工作

1、使用ubuntu云归档库和密钥
```bash
echo "deb http://ubuntu-cloud.archive.canonical.com/ubuntu" \
  "trusty-updates/juno main" > /etc/apt/sources.list.d/cloudarchive-juno.list
apt-get update
apt-get install ubuntu-cloud-keyring
```
2、设置DataStax库
```bash
echo "deb http://debian.datastax.com/community stable main" > /etc/apt/sources.list.d/datastax.list
```
并下载安装库密钥
```bash
curl -L http://debian.datastax.com/debian/repo_key | apt-key add -
```
3、配置midonet库
创建文件/etc/apt/sources.list.d/midonet.list写入以下内容
```bash
# MidoNet
deb http://repo.midonet.org/midonet/v2014.11 stable main
# MidoNet OpenStack Integration
deb http://repo.midonet.org/openstack-juno stable main
# MidoNet 3rd Party Tools and Libraries
deb http://repo.midonet.org/misc stable main
```
下载并安装库密钥
```bash
curl -k http://repo.midonet.org/packages.midokura.key | apt-key add -
```
4、更新源
```bash
apt-get update
```
5、安装数据库(mysql)
选用percona的分支版本(安装部署过程略)

安装python-mysqldb模块
```
apt-get install python-mysqldb
```
6、安装rabbitmq
```
apt-get install rabbitmq-server
```
可以使用以下方法设置guest用户密码，替换`RABBIT_PASS`为想要的密码值
```
rabbitmqctl change_password guest RABBIT_PASS
```
重启服务
```
service rabbitmq-server restart
```

## midonet安装部署
### 一、安装身份认证服务(keystone)
1、创建keystone数据库
```
登陆mysql
mysql -u root -p
创建keystone数据库
CREATE DATABASE keystone;
为keystone库授权
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \
  IDENTIFIED BY 'KEYSTONE_DBPASS';
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \
  IDENTIFIED BY 'KEYSTONE_DBPASS';
```
2、生成一个随机值为做初始配置的管理令牌
```
openssl rand -hex 10
```
3、安装配置相关组件
```
apt-get install keystone python-keystoneclient
```
4、配置keystone
修改配置文件/etc/keystone/keystone.conf的以下内容
在[DEFAULT]段，修改`ADMIN_TOKEN`为刚才生成的令牌值
```
[DEFAULT]
...
admin_token = ADMIN_TOKEN
```
在[database]段，修改数据库的连接地址
```
[database]
...
connection = mysql://keystone:KEYSTONE_DBPASS@10.25.1.29/keystone
```
在[token]段, 配置uuid令牌的提供者和SQL驱动

```
[token]
...
provider = keystone.token.providers.uuid.Provider
driver = keystone.token.persistence.backends.sql.Token
```
在[revoke]段，修改sql revoke驱动
```
[revoke]
...
driver = keystone.contrib.revoke.backends.sql.Revoke
```
5、填充认证服务数据库
```
su -s /bin/sh -c "keystone-manage db_sync" keystone
```
6、初始化服务
重启服务
```
service keystone restart
```
ubuntu的包会默认创建一个SQLite服务，因为我们使用了自己安装的mysql，所以可以把SQLite文件删掉
```bash
rm -f /var/lib/keystone/keystone.db
```
7、创建用户、租户和规则
a、导入OS_SERVICE_TOKEN变量，`ADMIN_TOKEN`为我们之前生成的`token`
```bash
export OS_SERVICE_TOKEN=70d92d3bb14249b48534
```
b、导入OS_SERVICE_ENDPOINT变量
```bash
OS_SERVICE_ENDPOINT=http://10.25.1.29:35357/v2.0
```
c、创建管理租户、用户和规则
创建租户
```bash
keystone tenant-create --name admin --description "Admin Tenant"
```
创建用户，替换掉`ADMIN_PASS`和`EMAIL_ADDRESS`
```bash
keystone user-create --name admin --pass ADMIN_PASS --email EMAIL_ADDRESS
```
创建admin role
```bash
keystone role-create --name admin
```
将admin规则给admin租户和admin用户添加
```bash
keystone user-role-add --user admin --tenant admin --role admin
```
创建一个service租户
```bash
keystone tenant-create --name service --description "Service Tenant"
```
d、创建服务实体和认证服务
```bash
keystone service-create --name keystone --type identity --description "OpenStack Identity"
```
e、创建API endpoint
```
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ identity / {print $2}') \
  --publicurl http://10.25.1.29:5000/v2.0 \
  --internalurl http://10.25.1.29:5000/v2.0 \
  --adminurl http://10.25.1.29:35357/v2.0 \
  --region regionOne
```
f、创建midonet服务用户
替换midonet用户密码`MIDONET_PASS`
```
keystone service-create --name midonet --type midonet --description
"MidoNet API Service"
keystone user-create --name midonet --pass MIDONET_PASS --tenant admin
keystone user-role-add --user midonet --role admin --tenant admin
```
### 二、网络组件安装（neutron）
1、创建一个环境变量脚本admin-openrc.sh，替换掉`ADMIN_PASS`
```
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=ADMIN_PASS
export OS_AUTH_URL=http://10.25.1.29:35357/v2.0
```
2、导入环境变量
```
source admin-openrc.sh
```
3、按照以下步骤安装neutron及相关组件
a、创建数据库并赋用户权限
连接mysql
```
CREATE DATABASE neutron;
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \
  IDENTIFIED BY 'NEUTRON_DBPASS';
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \
  IDENTIFIED BY 'NEUTRON_DBPASS';
```
`NEUTRON_DBPASS`替换为可用密码
退出mysql
b、创建neutron用户、服务、规则和API endpoint
```
keystone user-create --name neutron --pass NEUTRON_PASS
keystone user-role-add --user neutron --tenant service --role admin
keystone service-create --name neutron --type network \
  --description "OpenStack Networking"
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ network / {print $2}') \
  --publicurl http://10.25.1.29:9696 \
  --adminurl http://10.25.1.29:9696 \
  --internalurl http://10.25.1.29:9696 \
  --region regionOne
```
替换`NEUTRON_PASS`为可用密码
c、安装neutron-server

```
git clone https://github.com/openstack/neutron.git
cd neutron
git branch v1.3 2014.1.3
git checkout v1.3
python setup.py build
python setup.py install
```
配置文件内容
```
[DEFAULT]
lock_path = $state_path/lock
core_plugin = midonet.neutron.plugin.MidonetPluginV2
auth_strategy = keystone
rabbit_host=127.0.0.1
[matchmaker_redis]
[matchmaker_ring]
[quotas]
[agent]
root_helper = sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf
[keystone_authtoken]
auth_uri = http://10.25.1.29:5000/v2.0
identity_uri = http://10.25.1.29:35357
admin_tenant_name = service
admin_user = neutron
admin_password = rain_neutron_123
[database]
connection = mysql://neutron:rain_neutron_123@10.25.1.29/neutron
[service_providers]
service_provider=LOADBALANCER:Haproxy:neutron.services.loadbalancer.drivers.haproxy.plugin_driver.HaproxyOnHostPluginDriver:default
service_provider=VPN:openswan:neutron.services.vpn.service_drivers.ipsec.IPsecVPNDriver:default
```
创建文件/etc/neutron/plugins/midonet/midonet.ini
```
[DATABASE]
sql_connection = mysql://neutron:rain_neutron_123@10.25.1.29/neutron
[MIDONET]
# MidoNet API URL
midonet_uri = http://10.25.1.29:8080/midonet-api
# MidoNet administrative user in Keystone
username = midonet
password = rain_midonet_123
# MidoNet administrative user's tenant
project_id = admin
```
d、安装python-neutron-plugin-midonet
```
git clone https://github.com/midokura/python-neutron-plugin-midonet.git
cd python-neutron-plugin-midonet
git branch v1.3 2014.1.3-1.0
git checkout v1.3
python setup.py build
python setup.py install
```
e、安装python-neutronclient
```
git clone https://github.com/openstack/python-neutronclient.git
cd python-neutronclient
git branch v2.3.4 2.3.4
git checkout v2.3.4
python setup.py build
python setup.py install
```
f、初始化数据库
```
su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/midonet/midonet.ini upgrade juno" neutron
```
g、重启服务
```
service neutron-server restart
```
h、验证
```
neutron ext-list
```
### 三、midonet安装
1、安装zookeeper
a、安装zookeeper各组件
```
apt-get install zookeeper zookeeperd zkdump
```
b、配置/etc/zookeeper/conf/zoo.cfg
```
server.1=10.25.1.27:2888:3888
server.2=10.25.1.28:2888:3888
server.3=10.25.1.29:2888:3888
```
c、分别在三台管理节点上创建/var/lib/zookeeper/myid文件

10.25.1.27（rain01）
```
echo 1 > /var/lib/zookeeper/myid
```
10.25.1.28（rain02）
```
echo 2 > /var/lib/zookeeper/myid
```
10.25.1.29（rain03）
```
echo 3 > /var/lib/zookeeper/myid
```
d、启动
```
service zookeeper restart
```
2、安装cassandra在rain03上安装，只安装一个即可
a、安装各组件
```
apt-get install openjdk-7-jre-headless
apt-get install dsc20=2.0.10-1 cassandra=2.0.10
apt-mark hold dsc20 cassandra
```
b、配置
修改配置文件/etc/cassandra/cassandra.yaml如下：
```
# The name of the cluster.
cluster_name: 'midonet'
...
# Addresses of hosts that are deemed contact points.
seed_provider:
- class_name: org.apache.cassandra.locator.SimpleSeedProvider
parameters:
- seeds: "10.25.1.29"
```
由于是一个节点，自己监听自己即可
```
# Address to bind to and tell other Cassandra nodes to connect to.
listen_address: 10.25.1.29
...
# The address to bind the Thrift RPC service.
rpc_address: 10.25.1.29
```
c、清除数据并重启
```
service cassandra stop
rm -rf /var/lib/cassandra/*
service cassandra start
```
3、安装midonet-api
a、安装midonet-api组件
```
apt-get install midonet-api
```
b、修改配置文件/usr/share/midonet-api/WEB-INF/web.xml包含以下内容，替换`ADMIN_TOKEN`：

```
<context-param>
<param-name>rest_api-base_uri</param-name>
<param-value>http://10.25.1.29:8080/midonet-api</param-value>
</context-param>
<context-param>
<param-name>keystone-service_host</param-name>
<param-value>10.25.1.29</param-value>
</context-param>
<context-param>
<param-name>keystone-admin_token</param-name>
<param-value>70d92d3bb14249b48534</param-value>
</context-param>
<context-param>
<param-name>zookeeper-zookeeper_hosts</param-name>
<param-value>10.25.1.27:2181,10.25.1.28:2181,10.25.1.29:2181</param-val»
ue>
</context-param>
```
4、安装tomcat7
```
apt-get install tomcat7
```
a、配置tomcat7
修改配置文件/usr/share/tomcat7/bin/catalina.sh包括以下内容:
```
JAVA_OPTS="$JAVA_OPTS -Djava.security.egd=file:/dev/./urandom"
```
b、创建/etc/tomcat7/Catalina/localhost/midonet-api.xml文件包含以下内容：
```
<Context
    path="/midonet-api"
    docBase="/usr/share/midonet-api"
    antiResourceLocking="false"
    privileged="true"
/>
```
c、重启服务
```
service tomcat7 restart
```
5、安装midonet-cli命令行工具
```
apt-get install python-midonetclient
```
a、创建~/.midonetrc文件包含以下内容
```
[cli]
api_url = http://10.25.1.29:8080/midonet-api
username = admin
password = rain_admin_123
project_id = admin
```
6、安装midoman
a、midoman节点包括rain03和tree01~07一共8台都要安装
```
apt-get install midolman
```
b、修改配置文件/etc/midolman/midolman.conf
```
[zookeeper]
zookeeper_hosts = 10.25.1.27:2181,10.25.1.28:2181,10.25.1.29:2181
...
[cassandra]
servers = 10.25.1.27,10.25.1.28,10.25.1.29
replication_factor = 3
cluster = midonet
```
同时修改以下内容：
```
bgpd_binary = /usr/lib/quagga/
```
c、重启服务
```
service midolman restart
```
7、midonet服务主机注册
a、进入cli命令行
```
midonet-cli
```
b、创建tunnel zone
```
midonet> tunnel-zone create name gre type gre
tzone0
```
c、查看注册节点主机
```
midonet> host list
host host0 name tree05 alive true
host host1 name tree02 alive true
host host2 name tree03 alive true
host host3 name tree06 alive true
host host4 name tree07 alive true
host host5 name tree01 alive true
host host6 name rain03 alive true
host host7 name tree04 alive true
```
### 四、使用neutron进行网络初始化
```
neutron net-create ext1 --router:external
```
