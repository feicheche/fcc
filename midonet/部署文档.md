# Midonet部署及使用Neutron网络初始化

------

本文档涉及以下内容：
> * 安装前的准备
> * midonet集群安装
> * 使用neutron进行网络初始化

## 准备工作

1、使用ubuntu云归档库和密钥
```bash
echo "deb http://ubuntu-cloud.archive.canonical.com/ubuntu" \
  "trusty-updates/juno main" > /etc/apt/sources.list.d/cloudarchive-juno.list
apt-get update
apt-get install ubuntu-cloud-keyring
```
2、设置DataStax库
```bash
echo "deb http://debian.datastax.com/community stable main" > /etc/apt/sources.list.d/datastax.list
```
并下载安装库密钥
```bash
curl -L http://debian.datastax.com/debian/repo_key | apt-key add -
```
3、配置midonet库
创建文件/etc/apt/sources.list.d/midonet.list写入以下内容
```bash
# MidoNet
deb http://repo.midonet.org/midonet/v2014.11 stable main
# MidoNet OpenStack Integration
deb http://repo.midonet.org/openstack-juno stable main
# MidoNet 3rd Party Tools and Libraries
deb http://repo.midonet.org/misc stable main
```
下载并安装库密钥
```bash
curl -k http://repo.midonet.org/packages.midokura.key | apt-key add -
```
4、更新源
```bash
apt-get update
```
5、安装数据库(mysql)
选用percona的分支版本(安装部署过程略)
安装python-mysqldb模块
```
apt-get install python-mysqldb
```
6、安装rabbitmq
```
apt-get install rabbitmq-server
```
可以使用以下方法设置guest用户密码，替换`RABBIT_PASS`为想要的密码值
```
rabbitmqctl change_password guest RABBIT_PASS
```
重启服务
```
service rabbitmq-server restart
```

## midonet安装部署
一、安装身份认证服务(keystone)
1、创建keystone数据库
```
登陆mysql
mysql -u root -p
创建keystone数据库
CREATE DATABASE keystone;
为keystone库受权
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \
  IDENTIFIED BY 'KEYSTONE_DBPASS';
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \
  IDENTIFIED BY 'KEYSTONE_DBPASS';
```
2、生成一个随机值为做初始配置的管理令牌
```
openssl rand -hex 10
```
3、安装配置相关组件
```
apt-get install keystone python-keystoneclient
```
4、配置keystone
修改配置文件/etc/keystone/keystone.conf的以下内容
在[DEFAULT]段，修改`ADMIN_TOKEN`为刚才生成的令牌值
```
[DEFAULT]
...
admin_token = ADMIN_TOKEN
```
在[database]段，修改数据库的连接地址
```
[database]
...
connection = mysql://keystone:KEYSTONE_DBPASS@10.25.1.29/keystone
```
在[token]段, 配置uuid令牌的提供者和SQL驱动

```
[token]
...
provider = keystone.token.providers.uuid.Provider
driver = keystone.token.persistence.backends.sql.Token
```
在[revoke]段，修改sql revoke驱动
```
[revoke]
...
driver = keystone.contrib.revoke.backends.sql.Revoke
```
5、填充认证服务数据库
```
su -s /bin/sh -c "keystone-manage db_sync" keystone
```
6、初始化服务
重启服务
```
service keystone restart
```
ubuntu的包会默认创建一个SQLite服务，因为我们使用了自己安装的mysql，所以可以把SQLite文件删掉
```
rm -f /var/lib/keystone/keystone.db
```
7、创建